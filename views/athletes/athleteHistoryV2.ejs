<div class="container mt-5">
  <h1 class="fw-bold text-primary mb-4">
    📈 Ιστορικό Πόντων - <%= athlete.full_name %>
  </h1>

  <a href="/athletes" class="btn btn-secondary mb-4">← Επιστροφή στους Αθλητές</a>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <% if (history && history.length > 0) { %>
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-hover align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>Ημερομηνία</th>
          <th>Πόντοι Πριν</th>
          <th>Πόντοι Μετά</th>
          <th>Αλλαγή</th>
          <th>Περιγραφή / Πηγή</th>
          <th style="width:140px;">Ενέργειες</th>
        </tr>
      </thead>
      <tbody>
        <% history.forEach(h => { %>
        <tr class="text-center">
          <td><%= h.date ? new Date(h.date).toISOString().slice(0,10) : '-' %></td>
          <td><%= h.points_before ?? '-' %></td>
          <td><%= h.points_after ?? '-' %></td>
          <td class="<%= h.change >= 0 ? 'text-success' : 'text-danger' %> fw-bold">
            <%= typeof h.change === 'number'
                ? (h.change >= 0 ? '+' + h.change.toFixed(2) : h.change.toFixed(2))
                : '-' %>
          </td>
          <td class="text-start">
            <% if (h.source === 'tournament') { %>
              🏆 <strong><%= h.reason %></strong>
            <% } else if (h.source === 'yearly') { %>
              📅 <em><%= h.reason %></em>
            <% } else { %>
              🧾 <%= h.reason || '-' %>
            <% } %>
          </td>
          <td class="text-center">
            <% if (currentUser && currentUser.role === 'admin') { %>
              <!-- Edit -->
              <button
                type="button"
                class="btn btn-sm btn-warning me-1"
                data-bs-toggle="modal"
                data-bs-target="#editModal<%= h.id %>"
                title="Επεξεργασία"
              >✏️</button>

              <!-- Delete -->
              <form
                action="/athlete/<%= athlete.id %>/history-v2/delete/<%= h.id %>"
                method="POST"
                style="display:inline-block"
                onsubmit="return confirm('Διαγραφή αυτής της εγγραφής;');"
              >
                <button class="btn btn-sm btn-danger" title="Διαγραφή">🗑️</button>
              </form>

              <!-- Edit Modal -->
              <div class="modal fade" id="editModal<%= h.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">✏️ Επεξεργασία Εγγραφής</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form action="/athlete/<%= athlete.id %>/history-v2/edit/<%= h.id %>" method="POST">
                      <div class="modal-body">
                        <div class="mb-3 text-start">
                          <label class="form-label">Πόντοι Πριν</label>
                          <input type="number" step="0.01" name="points_before" value="<%= h.points_before %>" class="form-control" required>
                        </div>
                        <div class="mb-3 text-start">
                          <label class="form-label">Πόντοι Μετά</label>
                          <input type="number" step="0.01" name="points_after" value="<%= h.points_after %>" class="form-control" required>
                        </div>
                        <div class="mb-3 text-start">
                          <label class="form-label">Περιγραφή</label>
                          <input type="text" name="description" value="<%= h.reason %>" class="form-control">
                        </div>
                        <div class="mb-3 text-start">
                          <label class="form-label">Περίοδος</label>
                          <input type="number" name="season_year" value="<%= h.season_year || 2025 %>" class="form-control">
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Άκυρο</button>
                        <button type="submit" class="btn btn-primary">💾 Αποθήκευση</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            <% } else { %>
              <span class="text-muted">—</span>
            <% } %>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
  <div class="alert alert-info shadow-sm text-center">
    Δεν υπάρχει ιστορικό για αυτόν τον αθλητή.
  </div>
  <% } %>

  <hr class="my-4">

  <!-- Add New Entry -->
  <% if (currentUser && currentUser.role === 'admin') { %>
  <h4>➕ Προσθήκη Νέας Εγγραφής (Μόνο για Διαχειριστές)</h4>
  <form action="/athlete/<%= athlete.id %>/history-v2/add" method="POST" class="row g-3 mt-3">
    <div class="col-md-3">
      <label class="form-label">Πόντοι Πριν</label>
      <input type="number" step="0.01" name="points_before" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Πόντοι Μετά</label>
      <input type="number" step="0.01" name="points_after" class="form-control" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Περιγραφή</label>
      <input type="text" name="description" class="form-control" placeholder="π.χ. Μείωση 25% ή bonus αγώνα">
    </div>
    <div class="col-md-2">
      <label class="form-label">Περίοδος</label>
      <input type="number" name="season_year" value="2025" class="form-control">
    </div>
    <div class="col-12 text-end">
      <button type="submit" class="btn btn-success mt-2">Αποθήκευση</button>
    </div>
  </form>
  <% } %>
</div>
