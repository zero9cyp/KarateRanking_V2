<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<div class="container mt-5 mb-5">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-primary mb-0">
      <i class="bi bi-trophy-fill"></i> Î Î¯Î½Î±ÎºÎ±Ï‚ Î‘Î¸Î»Î·Ï„ÏÎ½
    </h1>
    <button class="btn btn-outline-primary btn-sm" id="refreshBtn">
      <i class="bi bi-arrow-clockwise"></i> Î•Ï€Î±Î½Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ·
    </button>
  </div>

  <!-- Î¦Î¯Î»Ï„ÏÎ± -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
      <div class="row g-3 align-items-end">

        <div class="col-md-3">
          <label class="form-label fw-semibold">Î—Î»Î¹ÎºÎ¹Î±ÎºÎ® ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label>
          <select id="ageCategoryFilter" class="form-select" multiple>
            <% ageCategories.forEach(cat => { %>
              <option value="<%= cat.id %>"><%= cat.name %></option>
            <% }) %>
          </select>
          <small class="text-muted">ÎšÏÎ¬Ï„Î·ÏƒÎµ Ctrl / Cmd Î³Î¹Î± Ï€Î¿Î»Î»Î±Ï€Î»Î® ÎµÏ€Î¹Î»Î¿Î³Î®</small>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î’Î¬ÏÎ¿Ï…Ï‚</label>
          <select id="weightCategoryFilter" class="form-select">
            <option value="">ÎŒÎ»ÎµÏ‚</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold">Î¦ÏÎ»Î¿</label>
          <select id="genderFilter" class="form-select">
            <option value="">ÎŒÎ»Î±</option>
            <option value="male">Î†Î½Î´ÏÎµÏ‚</option>
            <option value="female">Î“Ï…Î½Î±Î¯ÎºÎµÏ‚</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold">Î‘Î³ÏÎ½Î±Ï‚</label>
          <select id="tournamentFilter" class="form-select">
            <option value="">ÎŒÎ»Î¿Î¹</option>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-center">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="withResultsOnly">
            <label class="form-check-label fw-semibold" for="withResultsOnly">
              ÎœÏŒÎ½Î¿ Î¼Îµ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±
            </label>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Î Î¯Î½Î±ÎºÎ±Ï‚ Î‘Î¸Î»Î·Ï„ÏÎ½ -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-people-fill"></i> Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î‘Î¸Î»Î·Ï„ÏÎ½</h5>
      <span class="badge bg-light text-dark" id="athleteCount"></span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0" id="athletesTable">
          <thead class="table-primary">
            <tr>
              <th style="width:50px;">#</th>
              <th>ÎŒÎ½Î¿Î¼Î±</th>
              <th>Î¦ÏÎ»Î¿</th>
              <th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th>
              <th>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î’Î¬ÏÎ¿Ï…Ï‚</th>
              <th>Î£Ï…Î½Î¿Î»Î¹ÎºÎ¿Î¯ Î ÏŒÎ½Ï„Î¿Î¹</th>
              <th>Î‘Î³ÏÎ½ÎµÏ‚</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Î›Î¿Î³Î¹ÎºÎ® JavaScript -->
<script>
  const ageCategorySelect = document.getElementById('ageCategoryFilter');
  const weightCategorySelect = document.getElementById('weightCategoryFilter');
  const genderSelect = document.getElementById('genderFilter');
  const tournamentSelect = document.getElementById('tournamentFilter');
  const withResultsCheckbox = document.getElementById('withResultsOnly');
  const tableBody = document.querySelector('#athletesTable tbody');
  const athleteCount = document.getElementById('athleteCount');
  const refreshBtn = document.getElementById('refreshBtn');

  let athletesData = [];
  let allTournaments = [];

  async function fetchAthletes(ageCategoryIds) {
    if (!ageCategoryIds || ageCategoryIds.length === 0) ageCategoryIds = ['all'];

    const res = await fetch(`/dashboard/age-multiple/${ageCategoryIds.join(',')}`);
    const data = await res.json();

    if (data.success) {
      athletesData = (data.athletes || []).sort((a, b) => a.full_name.localeCompare(b.full_name));
      allTournaments = data.tournaments || [];
      populateTournamentFilter();
      populateWeightFilter();
      renderTable();
    }
  }

  function populateTournamentFilter() {
    tournamentSelect.innerHTML = '<option value="">ÎŒÎ»Î¿Î¹</option>';
    allTournaments.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.name;
      opt.textContent = `${t.name} (${t.date || 'Ï‡Ï‰ÏÎ¯Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±'})`;
      tournamentSelect.appendChild(opt);
    });
  }

  function populateWeightFilter() {
    const uniqueWeights = [...new Set(athletesData.map(a => a.weight_category).filter(Boolean))].sort((a, b) => a.localeCompare(b));
    weightCategorySelect.innerHTML = '<option value="">ÎŒÎ»ÎµÏ‚</option>';
    uniqueWeights.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w;
      opt.textContent = w;
      weightCategorySelect.appendChild(opt);
    });
  }

  function renderTable() {
    const selectedTournament = tournamentSelect.value;
    const selectedWeight = weightCategorySelect.value;
    const selectedGender = genderSelect.value;
    const withResults = withResultsCheckbox.checked;

    tableBody.innerHTML = '';
    let visibleCount = 0;

    athletesData.forEach(a => {
      if (selectedWeight && a.weight_category !== selectedWeight) return;
      if (selectedGender && a.gender?.toLowerCase() !== selectedGender) return;

      let tournamentsToShow = a.tournaments || [];
      if (selectedTournament) {
        tournamentsToShow = tournamentsToShow.filter(t => t.name === selectedTournament);
      }
      if (withResults && tournamentsToShow.length === 0) return;

      visibleCount++;

      const genderBadge =
        a.gender === 'male'
          ? '<span class="badge bg-primary">M</span>'
          : a.gender === 'female'
            ? '<span class="badge bg-pink text-white">F</span>'
            : '-';

      const tournamentText = tournamentsToShow.length > 0
        ? tournamentsToShow.map(t => {
            const badge =
              t.placement === 1 ? '<span class="badge bg-success">ğŸ¥‡ 1Î· Î˜Î­ÏƒÎ·</span> ' :
              t.placement === 2 ? '<span class="badge bg-warning text-dark">ğŸ¥ˆ 2Î· Î˜Î­ÏƒÎ·</span> ' :
              t.placement === 3 ? '<span class="badge bg-info text-dark">ğŸ¥‰ 3Î· Î˜Î­ÏƒÎ·</span> ' : '';
            return `${badge}<strong>${t.name}</strong><br>
                    <small class="text-muted">${t.date || ''} | ÎÎ¯ÎºÎµÏ‚: ${t.wins || 0} | Î ÏŒÎ½Ï„Î¿Î¹: ${t.points_earned || 0}</small>`;
          }).join('<hr class="my-1">')
        : '<span class="text-muted">Î§Ï‰ÏÎ¯Ï‚ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</span>';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="text-center fw-bold">${visibleCount}</td>
        <td><i class="bi bi-person-circle text-primary me-1"></i> ${a.full_name}</td>
        <td>${genderBadge}</td>
        <td>${a.club_name || '-'}</td>
        <td>${a.weight_category || '-'}</td>
        <td><span class="fw-bold text-primary">${a.total_points ?? 0}</span></td>
        <td>${tournamentText}</td>
      `;
      tableBody.appendChild(row);
    });

    athleteCount.textContent = `${visibleCount} Î±Î¸Î»Î·Ï„${visibleCount === 1 ? 'Î®Ï‚' : 'Î­Ï‚'}`;
  }

  // --- Listeners ---
  ageCategorySelect.addEventListener('change', () => {
    const selected = Array.from(ageCategorySelect.selectedOptions).map(opt => opt.value);
    fetchAthletes(selected);
  });
  weightCategorySelect.addEventListener('change', renderTable);
  genderSelect.addEventListener('change', renderTable);
  tournamentSelect.addEventListener('change', renderTable);
  withResultsCheckbox.addEventListener('change', renderTable);
  refreshBtn.addEventListener('click', () => fetchAthletes(Array.from(ageCategorySelect.selectedOptions).map(opt => opt.value)));

  // Î‘ÏÏ‡Î¹ÎºÏŒ Ï†ÏŒÏÏ„Ï‰Î¼Î±
  fetchAthletes();
</script>

<style>
  .badge.bg-pink {
    background-color: #e83e8c;
  }
</style>
