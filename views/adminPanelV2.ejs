<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel V2</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
<div class="container py-5">
  <h1 class="mb-4">üèÜ Admin Panel (Ranking System V2)</h1>

  <% if (message) { %>
    <div class="alert alert-info"><%= message %></div>
  <% } %>

  <div class="row text-center mb-4">
    <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><h5 class="card-title">Athletes</h5><p class="display-6"><%= stats.athletes || 0 %></p></div></div></div>
    <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><h5 class="card-title">Tournaments</h5><p class="display-6"><%= stats.tournaments || 0 %></p></div></div></div>
    <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><h5 class="card-title">Results</h5><p class="display-6"><%= stats.results || 0 %></p></div></div></div>
    <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><h5 class="card-title">Clubs</h5><p class="display-6"><%= stats.clubs || 0 %></p></div></div></div>
  </div>

  <div class="text-center mb-5">
    <button id="recalcBtn" class="btn btn-primary btn-lg px-4">
      üîÑ Recalculate Rankings
    </button>
  </div>

  <div id="resultMsg" class="mt-4 text-center"></div>

  <h3 class="mt-5 mb-3">üìú Recalculation Logs (last 10)</h3>
  <table class="table table-bordered table-striped bg-white shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Admin</th>
        <th>Records</th>
        <th>Timestamp</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      <% if (logs && logs.length > 0) { %>
        <% logs.forEach((l, i)=>{ %>
          <tr>
            <td><%= i+1 %></td>
            <td><%= l.admin_name %></td>
            <td><%= l.recalculated %></td>
            <td><%= l.timestamp %></td>
            <td><%= l.notes %></td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="5" class="text-center text-muted">No recalculations logged yet.</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<script>
document.getElementById("recalcBtn").addEventListener("click", async () => {
  if (!confirm("‚ö†Ô∏è Are you sure you want to recalculate all rankings?")) return;

  const btn = document.getElementById("recalcBtn");
  const resultMsg = document.getElementById("resultMsg");
  btn.disabled = true;
  btn.textContent = "Recalculating... ‚è≥";
  resultMsg.innerHTML = "";

  try {
    const res = await fetch("/admin/recalculate-v2", { method: "POST" });
    const data = await res.json();

    if (data.success) {
      resultMsg.innerHTML = `<div class="alert alert-success">
        ‚úÖ Recalculated ${data.recalculated} results successfully.
      </div>`;
      setTimeout(() => window.location.reload(), 2000);
    } else {
      resultMsg.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error}</div>`;
    }
  } catch (err) {
    resultMsg.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Network or server error.</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "üîÑ Recalculate Rankings";
  }
});
</script>
</body>
</html>
